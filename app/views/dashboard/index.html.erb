<div class="dashboard-container p-6">
  <div class="header mb-6">
    <h1 class="text-3xl font-bold mb-4">分析ダッシュボード</h1>
    
    <!-- フィルター -->
    <div id="filters" class="mb-4">
      <%= form_with url: dashboard_path, method: :get, local: true do |f| %>
        <div class="flex gap-4">
          <%= select_tag :period, 
              options_for_select([
                ['全期間', 'all'],
                ['過去7日間', '7days'],
                ['過去30日間', '30days'],
                ['過去90日間', '90days']
              ], @period),
              class: 'form-select' %>
          <%= submit_tag 'フィルタ適用', class: 'btn btn-primary' %>
        </div>
      <% end %>
      
      <% if @period != 'all' %>
        <div class="mt-2 text-sm text-gray-600">
          <%= @period == '7days' ? '過去7日間' : @period == '30days' ? '過去30日間' : '過去90日間' %>のデータ
        </div>
      <% end %>
    </div>
    
    <!-- アクションボタン -->
    <div class="flex gap-4">
      <%= button_tag 'データを更新', 
          class: 'btn btn-secondary',
          onclick: 'location.reload()' %>
      <%= link_to 'CSVエクスポート', 
          dashboard_export_path(format: :csv),
          class: 'btn btn-outline' %>
      <%= button_to '未分析の会話を一括分析',
          dashboard_bulk_analyze_path,
          method: :post,
          class: 'btn btn-primary' %>
    </div>
  </div>

  <!-- 統計サマリー -->
  <div id="statistics-summary" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
    <div class="stat-card bg-white p-4 rounded shadow">
      <h3 class="text-sm text-gray-600">総会話数</h3>
      <p class="text-2xl font-bold"><%= @statistics[:total_conversations] %></p>
    </div>
    <div class="stat-card bg-white p-4 rounded shadow">
      <h3 class="text-sm text-gray-600">分析済み</h3>
      <p class="text-2xl font-bold"><%= @statistics[:analyzed_count] %></p>
    </div>
    <div class="stat-card bg-white p-4 rounded shadow">
      <h3 class="text-sm text-gray-600">エスカレーション</h3>
      <p class="text-2xl font-bold"><%= @statistics[:escalation_count] %></p>
    </div>
    <div class="stat-card bg-white p-4 rounded shadow">
      <h3 class="text-sm text-gray-600">平均メッセージ数</h3>
      <p class="text-2xl font-bold"><%= @statistics[:average_messages].round(1) %></p>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- 感情分析の分布 -->
    <div id="sentiment-distribution" class="bg-white p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">感情分析</h2>
      <div class="chart-container">
        <div id="sentiment-chart">
          <canvas id="sentimentPieChart"></canvas>
        </div>
        <div class="legend mt-4">
          <div class="flex justify-around">
            <span class="flex items-center">
              <span class="w-3 h-3 bg-green-500 rounded-full mr-2"></span>
              ポジティブ: <%= @sentiment_distribution['positive'] || 0 %>
            </span>
            <span class="flex items-center">
              <span class="w-3 h-3 bg-red-500 rounded-full mr-2"></span>
              ネガティブ: <%= @sentiment_distribution['negative'] || 0 %>
            </span>
            <span class="flex items-center">
              <span class="w-3 h-3 bg-gray-500 rounded-full mr-2"></span>
              ニュートラル: <%= @sentiment_distribution['neutral'] || 0 %>
            </span>
          </div>
        </div>
      </div>
    </div>

    <!-- 優先度別の件数 -->
    <div id="priority-breakdown" class="bg-white p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">優先度別</h2>
      <div class="chart-container">
        <div id="priority-chart">
          <canvas id="priorityBarChart"></canvas>
        </div>
        <div class="priority-list mt-4">
          <div class="space-y-2">
            <div class="flex justify-between">
              <span>高</span>
              <span class="font-bold"><%= @priority_breakdown['high'] || 0 %></span>
            </div>
            <div class="flex justify-between">
              <span>中</span>
              <span class="font-bold"><%= @priority_breakdown['medium'] || 0 %></span>
            </div>
            <div class="flex justify-between">
              <span>低</span>
              <span class="font-bold"><%= @priority_breakdown['low'] || 0 %></span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 時系列グラフ -->
  <div id="timeline-chart" class="bg-white p-4 rounded shadow mt-6">
    <h2 class="text-xl font-semibold mb-4">会話数の推移</h2>
    <canvas id="timelineChart"></canvas>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-6">
    <!-- エスカレーション案件リスト -->
    <div id="escalation-list" class="bg-white p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">エスカレーション案件</h2>
      <div class="space-y-3">
        <% @escalations.each do |escalation| %>
          <div class="border-l-4 border-red-500 pl-3 py-2">
            <div class="flex justify-between items-center">
              <div>
                <span class="font-medium">会話 #<%= escalation.conversation_id %></span>
                <span class="ml-2 px-2 py-1 bg-red-100 text-red-700 text-xs rounded">
                  <%= escalation.priority_level %>
                </span>
              </div>
              <%= link_to '詳細', 
                  conversation_path(escalation.conversation),
                  class: 'text-blue-600 hover:underline' %>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              <%= escalation.created_at.strftime('%Y-%m-%d %H:%M') %>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- 最近の会話リスト -->
    <div id="recent-conversations" class="bg-white p-4 rounded shadow">
      <h2 class="text-xl font-semibold mb-4">最近の会話</h2>
      <div class="space-y-3">
        <% @recent_conversations.each do |conversation| %>
          <div class="border-l-4 border-blue-500 pl-3 py-2">
            <div class="flex justify-between items-center">
              <div>
                <span class="font-medium">会話 #<%= conversation.id %></span>
                <span class="ml-2 text-sm text-gray-600">
                  メッセージ: <%= conversation.messages.count %>
                </span>
              </div>
              <%= link_to '表示', 
                  conversation_path(conversation),
                  class: 'text-blue-600 hover:underline' %>
            </div>
            <div class="text-sm text-gray-600 mt-1">
              <%= conversation.created_at.strftime('%Y-%m-%d %H:%M') %>
            </div>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- プログレスバー（一括分析用） -->
  <div class="progress-bar hidden fixed bottom-4 right-4 bg-white p-4 rounded shadow-lg w-80">
    <h3 class="font-semibold mb-2">分析中...</h3>
    <div class="w-full bg-gray-200 rounded-full h-2.5">
      <div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
    </div>
    <p class="text-sm text-gray-600 mt-2">処理中: <span class="progress-text">0%</span></p>
  </div>

  <!-- エスカレーションアラート -->
  <div class="escalation-alert hidden fixed top-4 right-4 bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-lg">
    <p class="font-bold">新しいエスカレーション</p>
    <p class="text-sm">緊急対応が必要な案件が発生しました</p>
  </div>
</div>

<!-- モバイル対応CSS -->
<style>
  @media (max-width: 768px) {
    .chart-container {
      @apply mobile-layout;
    }
    
    .mobile-menu-button {
      @apply block;
    }
  }
  
  .mobile-menu-button {
    @apply hidden;
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // 感情分析の円グラフ
  const sentimentCtx = document.getElementById('sentimentPieChart');
  if (sentimentCtx) {
    new Chart(sentimentCtx, {
      type: 'pie',
      data: {
        labels: ['ポジティブ', 'ネガティブ', 'ニュートラル'],
        datasets: [{
          data: [
            <%= @sentiment_distribution['positive'] || 0 %>,
            <%= @sentiment_distribution['negative'] || 0 %>,
            <%= @sentiment_distribution['neutral'] || 0 %>
          ],
          backgroundColor: ['#10b981', '#ef4444', '#6b7280']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
  }
  
  // 優先度の棒グラフ
  const priorityCtx = document.getElementById('priorityBarChart');
  if (priorityCtx) {
    new Chart(priorityCtx, {
      type: 'bar',
      data: {
        labels: ['高', '中', '低'],
        datasets: [{
          label: '件数',
          data: [
            <%= @priority_breakdown['high'] || 0 %>,
            <%= @priority_breakdown['medium'] || 0 %>,
            <%= @priority_breakdown['low'] || 0 %>
          ],
          backgroundColor: ['#ef4444', '#f59e0b', '#10b981']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
  
  // 時系列グラフ
  const timelineCtx = document.getElementById('timelineChart');
  if (timelineCtx) {
    new Chart(timelineCtx, {
      type: 'line',
      data: {
        labels: <%= @timeline_data.keys.map { |d| d.strftime('%m/%d') }.to_json.html_safe %>,
        datasets: [{
          label: '会話数',
          data: <%= @timeline_data.values.to_json %>,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  }
});
</script>