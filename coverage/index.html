<!DOCTYPE html>
<html xmlns='http://www.w3.org/1999/xhtml'>
  <head>
    <title>Code coverage for Intelligenter-chatbot</title>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <script src='./assets/0.13.2/application.js' type='text/javascript'></script>
    <link href='./assets/0.13.2/application.css' media='screen, projection, print' rel='stylesheet' type='text/css' />
    <link rel="icon" type="image/png" href="./assets/0.13.2/favicon_red.png" />
  </head>

  <body>
    <div id="loading">
      <img src="./assets/0.13.2/loading.gif" alt="loading"/>
    </div>
    <div id="wrapper" class="hide">
      <div class="timestamp">Generated <abbr class="timeago" title="2025-08-21T18:47:29+09:00">2025-08-21T18:47:29+09:00</abbr></div>
      <ul class="group_tabs"></ul>

      <div id="content">
        <div class="file_list_container" id="AllFiles">
  <h2>
    <span class="group_name">All Files</span>
    (<span class="covered_percent">
      <span class="red">
  50.52%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         1.38
       </span>
    </span> hits/line
    )
  </h2>

  <a name="AllFiles"></a>

  <div>
    <b>14</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>384</b> relevant lines,
    <span class="green"><b>194</b> lines covered</span> and
    <span class="red"><b>190</b> lines missed. </span>
    (<span class="red">
  50.52%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ce7a0eeceaa6679f6450e6f8bcc510983a852c87" class="src_link" title="app/channels/application_cable/channel.rb">app/channels/application_cable/channel.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5bba928c0061856ab1f5e0316a417372e0339224" class="src_link" title="app/channels/application_cable/connection.rb">app/channels/application_cable/connection.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.57</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f8233f05224664def5c02a42b42679e6848c2ab6" class="src_link" title="app/channels/chat_channel.rb">app/channels/chat_channel.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.04 %</td>
            <td class="cell--number">154</td>
            <td class="cell--number">51</td>
            <td class="cell--number">50</td>
            <td class="cell--number">1</td>
            <td class="cell--number">4.39</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8e27c60ffe98fff3a6546d88a53ef481d533e32f" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2bcfe83f79c5a49ca7e5d9b6ac0f4e0962c559ac" class="src_link" title="app/controllers/demo_controller.rb">app/controllers/demo_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">6</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ec69e6ee8c426327c424cc18f227a955d97ab09f" class="src_link" title="app/jobs/analyze_conversation_job.rb">app/jobs/analyze_conversation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">181</td>
            <td class="cell--number">140</td>
            <td class="cell--number">0</td>
            <td class="cell--number">140</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#902bc19416b16f84ebf4106b9fdcb402fa4c7c33" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a2e2f438ac308fdd651c9a023797a5d6bc4c2000" class="src_link" title="app/jobs/process_ai_response_job.rb">app/jobs/process_ai_response_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">32.35 %</td>
            <td class="cell--number">93</td>
            <td class="cell--number">34</td>
            <td class="cell--number">11</td>
            <td class="cell--number">23</td>
            <td class="cell--number">0.32</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a11c9ef110fe9548ed41a7349867f5ca4e20064d" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#82ef06e1a2ae211fd55a98dcf3fe1f916256a3a2" class="src_link" title="app/models/analysis.rb">app/models/analysis.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">82.05 %</td>
            <td class="cell--number">77</td>
            <td class="cell--number">39</td>
            <td class="cell--number">32</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1.31</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b6845982e215e07bf248b6f3d835cb8666e9d367" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#349df974fac31926228c4fc4ce8a3fe35e579c2e" class="src_link" title="app/models/conversation.rb">app/models/conversation.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">89.29 %</td>
            <td class="cell--number">57</td>
            <td class="cell--number">28</td>
            <td class="cell--number">25</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3.36</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#387a187f9cc7b49eadc710eda8aa9ed7edb6729a" class="src_link" title="app/models/message.rb">app/models/message.rb</a></td>
            <td class="green strong cell--number t-file__coverage">91.89 %</td>
            <td class="cell--number">77</td>
            <td class="cell--number">37</td>
            <td class="cell--number">34</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2.54</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ab4c1204c31a7b7406d353481725877193c325f5" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">92.00 %</td>
            <td class="cell--number">52</td>
            <td class="cell--number">25</td>
            <td class="cell--number">23</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1.12</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>


        
          <div class="file_list_container" id="Controllers">
  <h2>
    <span class="group_name">Controllers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Controllers"></a>

  <div>
    <b>2</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>7</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>7</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#8e27c60ffe98fff3a6546d88a53ef481d533e32f" class="src_link" title="app/controllers/application_controller.rb">app/controllers/application_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#2bcfe83f79c5a49ca7e5d9b6ac0f4e0962c559ac" class="src_link" title="app/controllers/demo_controller.rb">app/controllers/demo_controller.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">6</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0</td>
            <td class="cell--number">5</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Channels">
  <h2>
    <span class="group_name">Channels</span>
    (<span class="covered_percent">
      <span class="green">
  98.51%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         3.7
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Channels"></a>

  <div>
    <b>3</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>67</b> relevant lines,
    <span class="green"><b>66</b> lines covered</span> and
    <span class="red"><b>1</b> lines missed. </span>
    (<span class="green">
  98.51%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ce7a0eeceaa6679f6450e6f8bcc510983a852c87" class="src_link" title="app/channels/application_cable/channel.rb">app/channels/application_cable/channel.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#5bba928c0061856ab1f5e0316a417372e0339224" class="src_link" title="app/channels/application_cable/connection.rb">app/channels/application_cable/connection.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">28</td>
            <td class="cell--number">14</td>
            <td class="cell--number">14</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.57</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#f8233f05224664def5c02a42b42679e6848c2ab6" class="src_link" title="app/channels/chat_channel.rb">app/channels/chat_channel.rb</a></td>
            <td class="green strong cell--number t-file__coverage">98.04 %</td>
            <td class="cell--number">154</td>
            <td class="cell--number">51</td>
            <td class="cell--number">50</td>
            <td class="cell--number">1</td>
            <td class="cell--number">4.39</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Models">
  <h2>
    <span class="group_name">Models</span>
    (<span class="covered_percent">
      <span class="yellow">
  88.55%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="green">
         2.05
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Models"></a>

  <div>
    <b>5</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>131</b> relevant lines,
    <span class="green"><b>116</b> lines covered</span> and
    <span class="red"><b>15</b> lines missed. </span>
    (<span class="yellow">
  88.55%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#82ef06e1a2ae211fd55a98dcf3fe1f916256a3a2" class="src_link" title="app/models/analysis.rb">app/models/analysis.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">82.05 %</td>
            <td class="cell--number">77</td>
            <td class="cell--number">39</td>
            <td class="cell--number">32</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1.31</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#b6845982e215e07bf248b6f3d835cb8666e9d367" class="src_link" title="app/models/application_record.rb">app/models/application_record.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2</td>
            <td class="cell--number">2</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#349df974fac31926228c4fc4ce8a3fe35e579c2e" class="src_link" title="app/models/conversation.rb">app/models/conversation.rb</a></td>
            <td class="yellow strong cell--number t-file__coverage">89.29 %</td>
            <td class="cell--number">57</td>
            <td class="cell--number">28</td>
            <td class="cell--number">25</td>
            <td class="cell--number">3</td>
            <td class="cell--number">3.36</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#387a187f9cc7b49eadc710eda8aa9ed7edb6729a" class="src_link" title="app/models/message.rb">app/models/message.rb</a></td>
            <td class="green strong cell--number t-file__coverage">91.89 %</td>
            <td class="cell--number">77</td>
            <td class="cell--number">37</td>
            <td class="cell--number">34</td>
            <td class="cell--number">3</td>
            <td class="cell--number">2.54</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ab4c1204c31a7b7406d353481725877193c325f5" class="src_link" title="app/models/user.rb">app/models/user.rb</a></td>
            <td class="green strong cell--number t-file__coverage">92.00 %</td>
            <td class="cell--number">52</td>
            <td class="cell--number">25</td>
            <td class="cell--number">23</td>
            <td class="cell--number">2</td>
            <td class="cell--number">1.12</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Mailers">
  <h2>
    <span class="group_name">Mailers</span>
    (<span class="covered_percent">
      <span class="red">
  0.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Mailers"></a>

  <div>
    <b>1</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>4</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>4</b> lines missed. </span>
    (<span class="red">
  0.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a11c9ef110fe9548ed41a7349867f5ca4e20064d" class="src_link" title="app/mailers/application_mailer.rb">app/mailers/application_mailer.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">4</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0</td>
            <td class="cell--number">4</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Helpers">
  <h2>
    <span class="group_name">Helpers</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Helpers"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Jobs">
  <h2>
    <span class="group_name">Jobs</span>
    (<span class="covered_percent">
      <span class="red">
  6.86%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.07
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Jobs"></a>

  <div>
    <b>3</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>175</b> relevant lines,
    <span class="green"><b>12</b> lines covered</span> and
    <span class="red"><b>163</b> lines missed. </span>
    (<span class="red">
  6.86%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#ec69e6ee8c426327c424cc18f227a955d97ab09f" class="src_link" title="app/jobs/analyze_conversation_job.rb">app/jobs/analyze_conversation_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">0.00 %</td>
            <td class="cell--number">181</td>
            <td class="cell--number">140</td>
            <td class="cell--number">0</td>
            <td class="cell--number">140</td>
            <td class="cell--number">0.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#902bc19416b16f84ebf4106b9fdcb402fa4c7c33" class="src_link" title="app/jobs/application_job.rb">app/jobs/application_job.rb</a></td>
            <td class="green strong cell--number t-file__coverage">100.00 %</td>
            <td class="cell--number">7</td>
            <td class="cell--number">1</td>
            <td class="cell--number">1</td>
            <td class="cell--number">0</td>
            <td class="cell--number">1.00</td>
            
          </tr>
        
          <tr class="t-file">
            <td class="strong t-file__name"><a href="#a2e2f438ac308fdd651c9a023797a5d6bc4c2000" class="src_link" title="app/jobs/process_ai_response_job.rb">app/jobs/process_ai_response_job.rb</a></td>
            <td class="red strong cell--number t-file__coverage">32.35 %</td>
            <td class="cell--number">93</td>
            <td class="cell--number">34</td>
            <td class="cell--number">11</td>
            <td class="cell--number">23</td>
            <td class="cell--number">0.32</td>
            
          </tr>
        
      </tbody>
    </table>
  </div>
</div>

        
          <div class="file_list_container" id="Libraries">
  <h2>
    <span class="group_name">Libraries</span>
    (<span class="covered_percent">
      <span class="green">
  100.0%
</span>

     </span>
     covered at
     <span class="covered_strength">
       <span class="red">
         0.0
       </span>
    </span> hits/line
    )
  </h2>

  <a name="Libraries"></a>

  <div>
    <b>0</b> files in total.
  </div>

  <div class="t-line-summary">
    <b>0</b> relevant lines,
    <span class="green"><b>0</b> lines covered</span> and
    <span class="red"><b>0</b> lines missed. </span>
    (<span class="green">
  100.0%
</span>
)
  </div>

  

  <div class="file_list--responsive">
    <table class="file_list">
      <thead>
        <tr>
          <th>File</th>
          <th class="cell--number">% covered</th>
          <th class="cell--number">Lines</th>
          <th class="cell--number">Relevant Lines</th>
          <th class="cell--number">Lines covered</th>
          <th class="cell--number">Lines missed</th>
          <th class="cell--number">Avg. Hits / Line</th>
          
        </tr>
      </thead>
      <tbody>
        
      </tbody>
    </table>
  </div>
</div>

        
      </div>

      <div id="footer">
        Generated by <a href="https://github.com/simplecov-ruby/simplecov">simplecov</a> v0.22.0
        and simplecov-html v0.13.2<br/>
        using RSpec
      </div>

      <div class="source_files">
      
        <div class="source_table" id="ce7a0eeceaa6679f6450e6f8bcc510983a852c87">
  <div class="header">
    <h3>app/channels/application_cable/channel.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module ApplicationCable</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class Channel &lt; ActionCable::Channel::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="5bba928c0061856ab1f5e0316a417372e0339224">
  <div class="header">
    <h3>app/channels/application_cable/connection.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>14</b> relevant lines.
      <span class="green"><b>14</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">module ApplicationCable</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  class Connection &lt; ActionCable::Connection::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    identified_by :current_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def connect</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="6">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      self.current_user = find_verified_user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      logger.add_tags &#39;ActionCable&#39;, current_user.email</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def find_verified_user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">      # セッションまたはトークンベースの認証</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="14">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      if (user = find_user_from_session)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">        user</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby">      else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="17">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        reject_unauthorized_connection</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="21">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    def find_user_from_session</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">      # セッションからユーザーを取得</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="23">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      if (session_user_id = cookies.encrypted[:user_id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="24">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">        User.find_by(id: session_user_id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby">      end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="f8233f05224664def5c02a42b42679e6848c2ab6">
  <div class="header">
    <h3>app/channels/chat_channel.rb</h3>
    <h4>
      <span class="green">
  98.04%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>51</b> relevant lines.
      <span class="green"><b>50</b> lines covered</span> and
      <span class="red"><b>1</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ChatChannel &lt; ApplicationCable::Channel</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def subscribed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">    # 会話IDを元にストリームを購読</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="15" data-linenumber="4">
            
              <span class="hits">15</span>
            

            

            <code class="ruby">    return reject if params[:conversation_id].blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="6">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">    @conversation = Conversation.find_by(id: params[:conversation_id])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="14" data-linenumber="7">
            
              <span class="hits">14</span>
            

            

            <code class="ruby">    return reject unless @conversation &amp;&amp; authorized?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="9">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">    stream_from channel_name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="10">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">    broadcast_user_connected</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def unsubscribed</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby">    # 切断通知</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="15">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    if @conversation</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="16">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">        channel_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby">        {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">          type: &#39;user_disconnected&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">          user: current_user.slice(:id, :name, :email),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">          timestamp: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby">      )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="26">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    stop_all_streams</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  # メッセージ送信アクション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def send_message(data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="31">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    return unless @conversation &amp;&amp; authorized?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="33">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    message = build_user_message(data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="34">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    handle_message_save(message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">  # タイピング通知</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def typing(data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="39">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    return unless @conversation &amp;&amp; authorized?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      channel_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">        type: &#39;typing&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">        user: current_user.slice(:id, :name),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">        is_typing: data[&#39;is_typing&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  # 既読通知</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def mark_as_read(data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="53">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    return unless @conversation &amp;&amp; authorized?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="54">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    return if data[&#39;message_id&#39;].blank?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="56">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    message = @conversation.messages.find_by(id: data[&#39;message_id&#39;])</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="57">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    return unless message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="59">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    update_message_read_status(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="60">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    broadcast_message_read(message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="63">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="65">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def channel_name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="33" data-linenumber="66">
            
              <span class="hits">33</span>
            

            

            <code class="ruby">    &quot;conversation_#{@conversation.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="69">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def authorized?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">    # ユーザーがこの会話に参加できるか確認</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="21" data-linenumber="71">
            
              <span class="hits">21</span>
            

            

            <code class="ruby">    @conversation.user_id == current_user.id || current_user.admin?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">  rescue StandardError</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="76">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def broadcast_message(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="77">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="78">
            

            

            <code class="ruby">      channel_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">        type: &#39;new_message&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">        message: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby">          id: message.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby">          content: message.content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="84">
            

            

            <code class="ruby">          role: message.role,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">          created_at: message.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">          user: current_user.slice(:id, :name, :email)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="92">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def should_process_ai_response?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">    # 最後のメッセージがユーザーからの場合のみAI応答を生成</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="94">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    @conversation.messages.last&amp;.from_user?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="95">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="96">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="97">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def broadcast_user_connected</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="12" data-linenumber="98">
            
              <span class="hits">12</span>
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="99">
            

            

            <code class="ruby">      channel_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="100">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="101">
            

            

            <code class="ruby">        type: &#39;user_connected&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="102">
            

            

            <code class="ruby">        user: current_user.slice(:id, :name, :email),</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby">        timestamp: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="104">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="106">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="107">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="108">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def build_user_message(data)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="109">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    @conversation.messages.build(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">      content: data[&#39;content&#39;],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="111">
            

            

            <code class="ruby">      role: &#39;user&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="112">
            

            

            <code class="ruby">      metadata: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby">        sender_id: current_user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="114">
            

            

            <code class="ruby">        sent_at: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="116">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="118">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="119">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def handle_message_save(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="120">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    if message.save</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="121">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      broadcast_message(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="122">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">      ProcessAiResponseJob.perform_later(message.id) if should_process_ai_response?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="123">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="124">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">      transmit_error(message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="125">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="126">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="127">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="128">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def transmit_error(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="129">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    transmit(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="130">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="131">
            

            

            <code class="ruby">        type: &#39;error&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="132">
            

            

            <code class="ruby">        message: &#39;メッセージの送信に失敗しました&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="133">
            

            

            <code class="ruby">        errors: message.errors.full_messages</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="134">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="136">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="137">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="138">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update_message_read_status(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="139">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    message.add_metadata(&#39;read_by&#39;, current_user.id)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="140">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    message.add_metadata(&#39;read_at&#39;, Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="141">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="143">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def broadcast_message_read(message)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="144">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby">      channel_name,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="146">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="147">
            

            

            <code class="ruby">        type: &#39;message_read&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="148">
            

            

            <code class="ruby">        message_id: message.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="149">
            

            

            <code class="ruby">        user_id: current_user.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="150">
            

            

            <code class="ruby">        timestamp: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="151">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="152">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="153">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="154">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="8e27c60ffe98fff3a6546d88a53ef481d533e32f">
  <div class="header">
    <h3>app/controllers/application_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ApplicationController &lt; ActionController::API</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="2bcfe83f79c5a49ca7e5d9b6ac0f4e0962c559ac">
  <div class="header">
    <h3>app/controllers/demo_controller.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>5</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>5</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class DemoController &lt; ApplicationController</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  def components</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">    # デモページを表示</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">    render layout: false</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ec69e6ee8c426327c424cc18f227a955d97ab09f">
  <div class="header">
    <h3>app/jobs/analyze_conversation_job.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>140</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>140</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class AnalyzeConversationJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  queue_as :analysis</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">  def perform(conversation_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    conversation = Conversation.find(conversation_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    return unless conversation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    messages = conversation.messages.chronological</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="9">
            

            

            <code class="ruby">    return if messages.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    analysis = create_analysis(conversation, messages)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="12">
            

            

            <code class="ruby">    handle_escalation(conversation, analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="13">
            

            

            <code class="ruby">    broadcast_analysis_result(conversation, analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="14">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="15">
            

            

            <code class="ruby">    Rails.logger.error &quot;Analysis Error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="16">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">  def perform_analysis(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby">    # TODO: 実際のAI分析APIを呼び出す</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">    # ここでは仮の分析結果を返す</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="24">
            

            

            <code class="ruby">      hidden_needs: extract_hidden_needs(messages),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">      sentiment: analyze_sentiment(messages),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="26">
            

            

            <code class="ruby">      topics: extract_topics(messages),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">      urgency_level: calculate_urgency(messages),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="28">
            

            

            <code class="ruby">      confidence_score: 0.85,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="29">
            

            

            <code class="ruby">      evidence_quotes: extract_key_phrases(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="30">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="31">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="33">
            

            

            <code class="ruby">  def extract_hidden_needs(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">    # 仮実装：メッセージから隠れたニーズを抽出</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="35">
            

            

            <code class="ruby">    needs = []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    messages.each do |msg|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="38">
            

            

            <code class="ruby">      content = msg.content.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="39">
            

            

            <code class="ruby">      analyze_content_for_needs(content, needs)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="40">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="42">
            

            

            <code class="ruby">    needs.uniq</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">  def analyze_content_for_needs(content, needs)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="46">
            

            

            <code class="ruby">    needs &lt;&lt; { type: &#39;efficiency&#39;, confidence: 0.9 } if efficiency_needed?(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    needs &lt;&lt; { type: &#39;cost_optimization&#39;, confidence: 0.8 } if cost_optimization_needed?(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="48">
            

            

            <code class="ruby">    needs &lt;&lt; { type: &#39;automation&#39;, confidence: 0.85 } if automation_needed?(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">  def efficiency_needed?(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="52">
            

            

            <code class="ruby">    content.include?(&#39;遅い&#39;) || content.include?(&#39;時間&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="53">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="55">
            

            

            <code class="ruby">  def cost_optimization_needed?(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="56">
            

            

            <code class="ruby">    content.include?(&#39;高い&#39;) || content.include?(&#39;料金&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="57">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">  def automation_needed?(content)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="60">
            

            

            <code class="ruby">    content.include?(&#39;自動&#39;) || content.include?(&#39;手間&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">  def analyze_sentiment(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # 仮実装：感情分析</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    counts = count_sentiment_words(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="66">
            

            

            <code class="ruby">    calculate_sentiment_result(counts, messages.count)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">  def count_sentiment_words(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="70">
            

            

            <code class="ruby">    positive_words = %w[ありがとう 素晴らしい 良い 便利 助かる]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">    negative_words = %w[困る 問題 エラー 不便 遅い]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    counts = { positive: 0, negative: 0 }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    messages.each do |msg|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="76">
            

            

            <code class="ruby">      content = msg.content</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      counts[:positive] += positive_words.count { |word| content.include?(word) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      counts[:negative] += negative_words.count { |word| content.include?(word) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="79">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="81">
            

            

            <code class="ruby">    counts</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="82">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="83">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">  def calculate_sentiment_result(counts, message_count)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="85">
            

            

            <code class="ruby">    overall = determine_overall_sentiment(counts[:positive], counts[:negative])</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="87">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="88">
            

            

            <code class="ruby">      overall: overall,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="89">
            

            

            <code class="ruby">      positive_score: counts[:positive].to_f / message_count,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="90">
            

            

            <code class="ruby">      negative_score: counts[:negative].to_f / message_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="91">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="92">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="94">
            

            

            <code class="ruby">  def determine_overall_sentiment(positive_count, negative_count)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="95">
            

            

            <code class="ruby">    if positive_count &gt; negative_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="96">
            

            

            <code class="ruby">      &#39;positive&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="97">
            

            

            <code class="ruby">    elsif negative_count &gt; positive_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="98">
            

            

            <code class="ruby">      &#39;negative&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="99">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="100">
            

            

            <code class="ruby">      &#39;neutral&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="101">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="102">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="103">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="104">
            

            

            <code class="ruby">  def extract_topics(_messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="105">
            

            

            <code class="ruby">    # 仮実装：トピック抽出</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="106">
            

            

            <code class="ruby">    %w[技術的問題 料金相談 機能要望 使い方]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="107">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="108">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="109">
            

            

            <code class="ruby">  def extract_key_phrases(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="110">
            

            

            <code class="ruby">    # 仮実装：重要フレーズ抽出</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="111">
            

            

            <code class="ruby">    messages.last(3).map(&amp;:content).pluck(0..50)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="112">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="113">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="114">
            

            

            <code class="ruby">  def calculate_urgency(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="115">
            

            

            <code class="ruby">    # 仮実装：緊急度計算</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="116">
            

            

            <code class="ruby">    urgent_keywords = %w[至急 緊急 すぐに 今すぐ エラー 動かない]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="117">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="118">
            

            

            <code class="ruby">    urgent_count = messages.sum do |msg|</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="119">
            

            

            <code class="ruby">      urgent_keywords.count { |keyword| msg.content.include?(keyword) }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="120">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="121">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="122">
            

            

            <code class="ruby">    urgent_count &gt; 2 ? &#39;high&#39; : &#39;normal&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="123">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="124">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="125">
            

            

            <code class="ruby">  def determine_priority(analysis_result)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="126">
            

            

            <code class="ruby">    case analysis_result[:urgency_level]</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="127">
            

            

            <code class="ruby">    when &#39;high&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="128">
            

            

            <code class="ruby">      &#39;high&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="129">
            

            

            <code class="ruby">    when &#39;normal&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="130">
            

            

            <code class="ruby">      analysis_result[:sentiment][:overall] == &#39;negative&#39; ? &#39;medium&#39; : &#39;low&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="131">
            

            

            <code class="ruby">    else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="132">
            

            

            <code class="ruby">      &#39;low&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="133">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="134">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="135">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="136">
            

            

            <code class="ruby">  def should_escalate?(analysis_result)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="137">
            

            

            <code class="ruby">    analysis_result[:urgency_level] == &#39;high&#39; ||</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="138">
            

            

            <code class="ruby">      analysis_result[:sentiment][:overall] == &#39;negative&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="139">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="140">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="141">
            

            

            <code class="ruby">  def notify_escalation(conversation, _analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="142">
            

            

            <code class="ruby">    # TODO: エスカレーション通知を実装</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="143">
            

            

            <code class="ruby">    Rails.logger.info &quot;Escalation needed for conversation #{conversation.id}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="144">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="145">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="146">
            

            

            <code class="ruby">  def broadcast_analysis_result(conversation, analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="147">
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="148">
            

            

            <code class="ruby">      &quot;conversation_#{conversation.id}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="149">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="150">
            

            

            <code class="ruby">        type: &#39;analysis_complete&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="151">
            

            

            <code class="ruby">        analysis: {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="152">
            

            

            <code class="ruby">          id: analysis.id,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="153">
            

            

            <code class="ruby">          type: analysis.analysis_type,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="154">
            

            

            <code class="ruby">          priority: analysis.priority_level,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="155">
            

            

            <code class="ruby">          sentiment: analysis.sentiment,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="156">
            

            

            <code class="ruby">          hidden_needs: analysis.hidden_needs,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="157">
            

            

            <code class="ruby">          created_at: analysis.created_at</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="158">
            

            

            <code class="ruby">        }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="159">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="160">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="161">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="162">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="163">
            

            

            <code class="ruby">  def create_analysis(conversation, messages)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="164">
            

            

            <code class="ruby">    analysis_result = perform_analysis(messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="165">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="166">
            

            

            <code class="ruby">    conversation.analyses.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="167">
            

            

            <code class="ruby">      analysis_type: &#39;pattern&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="168">
            

            

            <code class="ruby">      analysis_data: analysis_result,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="169">
            

            

            <code class="ruby">      priority_level: determine_priority(analysis_result),</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="170">
            

            

            <code class="ruby">      sentiment: analysis_result[:sentiment][:overall],</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="171">
            

            

            <code class="ruby">      escalated: should_escalate?(analysis_result)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="172">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="173">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="174">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="175">
            

            

            <code class="ruby">  def handle_escalation(conversation, analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="176">
            

            

            <code class="ruby">    return unless analysis.needs_escalation?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="177">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="178">
            

            

            <code class="ruby">    analysis.escalate!</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="179">
            

            

            <code class="ruby">    notify_escalation(conversation, analysis)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="180">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="181">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="902bc19416b16f84ebf4106b9fdcb402fa4c7c33">
  <div class="header">
    <h3>app/jobs/application_job.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>1</b> relevant lines.
      <span class="green"><b>1</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationJob &lt; ActiveJob::Base</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # Automatically retry jobs that encountered a deadlock</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">  # retry_on ActiveRecord::Deadlocked</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="4">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby">  # Most jobs are safe to ignore if the underlying records are no longer available</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # discard_on ActiveJob::DeserializationError</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a2e2f438ac308fdd651c9a023797a5d6bc4c2000">
  <div class="header">
    <h3>app/jobs/process_ai_response_job.rb</h3>
    <h4>
      <span class="red">
  32.35%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>34</b> relevant lines.
      <span class="green"><b>11</b> lines covered</span> and
      <span class="red"><b>23</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ProcessAiResponseJob &lt; ApplicationJob</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  queue_as :ai_processing</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def perform(message_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="5">
            

            

            <code class="ruby">    message = Message.find(message_id)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="6">
            

            

            <code class="ruby">    return unless message&amp;.from_user?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="8">
            

            

            <code class="ruby">    process_ai_response(message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  rescue StandardError =&gt; e</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="10">
            

            

            <code class="ruby">    Rails.logger.error &quot;AI Response Error: #{e.message}&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="11">
            

            

            <code class="ruby">    broadcast_error(message.conversation, e.message) if message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def process_ai_response(message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="17">
            

            

            <code class="ruby">    conversation = message.conversation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="18">
            

            

            <code class="ruby">    ai_response = generate_ai_response(message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="19">
            

            

            <code class="ruby">    response_message = create_ai_message(conversation, ai_response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="20">
            

            

            <code class="ruby">    broadcast_ai_message(conversation, response_message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="21">
            

            

            <code class="ruby">    AnalyzeConversationJob.perform_later(conversation.id)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def create_ai_message(conversation, ai_response)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="25">
            

            

            <code class="ruby">    conversation.messages.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">      content: ai_response[:content],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby">      role: &#39;assistant&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">      metadata: build_ai_metadata(ai_response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def build_ai_metadata(ai_response)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="34">
            

            

            <code class="ruby">      ai_model: &#39;claude-3&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby">      processing_time: ai_response[:processing_time],</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">      confidence: ai_response[:confidence]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def broadcast_ai_message(conversation, response_message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">      &quot;conversation_#{conversation.id}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby">      build_broadcast_payload(response_message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="47">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def build_broadcast_payload(response_message)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="49">
            

            

            <code class="ruby">      type: &#39;new_message&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">      message: {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">        id: response_message.id,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">        content: response_message.content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby">        role: response_message.role,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="54">
            

            

            <code class="ruby">        created_at: response_message.created_at,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="55">
            

            

            <code class="ruby">        metadata: response_message.metadata</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="58">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="59">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="60">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def generate_ai_response(message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="61">
            

            

            <code class="ruby">    start_time = Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby">    # TODO: 実際のAI APIを呼び出す</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">    # ここでは仮の応答を返す</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="65">
            

            

            <code class="ruby">    content = case message.content.downcase</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="66">
            

            

            <code class="ruby">              when /こんにちは|hello/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="67">
            

            

            <code class="ruby">                &#39;こんにちは！お手伝いできることはありますか？&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby">              when /ありがとう|thank/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="69">
            

            

            <code class="ruby">                &#39;どういたしまして！他にご質問はございますか？&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">              when /さようなら|bye/</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="71">
            

            

            <code class="ruby">                &#39;ご利用ありがとうございました。またお待ちしております。&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="72">
            

            

            <code class="ruby">              else</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">                &quot;「#{message.content}」について承知いたしました。詳しくお聞かせください。&quot;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">              end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">    {</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="77">
            

            

            <code class="ruby">      content: content,</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="78">
            

            

            <code class="ruby">      processing_time: (Time.current - start_time).to_f,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="79">
            

            

            <code class="ruby">      confidence: 0.95</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="80">
            

            

            <code class="ruby">    }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="81">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="82">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="83">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def broadcast_error(conversation, error_message)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="84">
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="85">
            

            

            <code class="ruby">      &quot;conversation_#{conversation.id}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="86">
            

            

            <code class="ruby">      {</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="87">
            

            

            <code class="ruby">        type: &#39;error&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="88">
            

            

            <code class="ruby">        message: &#39;AI応答の生成中にエラーが発生しました&#39;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="89">
            

            

            <code class="ruby">        error: error_message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="90">
            

            

            <code class="ruby">      }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="91">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="92">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="93">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="a11c9ef110fe9548ed41a7349867f5ca4e20064d">
  <div class="header">
    <h3>app/mailers/application_mailer.rb</h3>
    <h4>
      <span class="red">
  0.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>4</b> relevant lines.
      <span class="green"><b>0</b> lines covered</span> and
      <span class="red"><b>4</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="1">
            

            

            <code class="ruby">class ApplicationMailer &lt; ActionMailer::Base</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="2">
            

            

            <code class="ruby">  default from: &#39;from@example.com&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="3">
            

            

            <code class="ruby">  layout &#39;mailer&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="4">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="82ef06e1a2ae211fd55a98dcf3fe1f916256a3a2">
  <div class="header">
    <h3>app/models/analysis.rb</h3>
    <h4>
      <span class="yellow">
  82.05%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>39</b> relevant lines.
      <span class="green"><b>32</b> lines covered</span> and
      <span class="red"><b>7</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Analysis &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # 定数</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  ANALYSIS_TYPES = %w[needs sentiment escalation pattern].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  PRIORITY_LEVELS = %w[low medium high urgent].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  SENTIMENTS = %w[positive neutral negative frustrated].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # アソシエーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :conversation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # バリデーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :analysis_type, presence: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">                            inclusion: { in: ANALYSIS_TYPES }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :analysis_data, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="14">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :priority_level, inclusion: { in: PRIORITY_LEVELS },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">                             allow_nil: true</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :sentiment, inclusion: { in: SENTIMENTS },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">                        allow_nil: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # デリゲーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  delegate :user, to: :conversation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  # スコープ</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="23">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :by_type, -&gt;(type) { where(analysis_type: type) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :escalated, -&gt; { where(escalated: true) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="25">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :not_escalated, -&gt; { where(escalated: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="26">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :high_priority, -&gt; { where(priority_level: %w[high urgent]) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="27">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">  scope :recent, -&gt; { order(created_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="28">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :needs_escalation, -&gt; { where(priority_level: &#39;high&#39;, escalated: false) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  # メソッド</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def needs_escalation?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="32">
            

            

            <code class="ruby">    priority_level == &#39;urgent&#39; || sentiment == &#39;frustrated&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="35">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def escalate!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="36">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    return if escalated?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="38">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    update!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby">      escalated: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">      escalated_at: Time.current</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def hidden_needs</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="45">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    return [] unless analysis_data &amp;&amp; analysis_data[&#39;hidden_needs&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="47">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    analysis_data[&#39;hidden_needs&#39;]</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def extract_hidden_needs</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    hidden_needs</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="54">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def sentiment_score</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="55">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    analysis_data&amp;.dig(&#39;sentiment&#39;, &#39;score&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def confidence_score</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="59">
            

            

            <code class="ruby">    analysis_data&amp;.dig(&#39;confidence_score&#39;) || 0.0</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="60">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="61">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="62">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def evidence_quotes</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="63">
            

            

            <code class="ruby">    analysis_data&amp;.dig(&#39;evidence_quotes&#39;) || []</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="64">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def requires_escalation?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="67">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    return false if escalated?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="68">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="69">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    priority_level == &#39;high&#39; || sentiment == &#39;frustrated&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="71">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="72">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update_analysis_data(key, value)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="73">
            

            

            <code class="ruby">    self.analysis_data ||= {}</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="74">
            

            

            <code class="ruby">    self.analysis_data[key] = value</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="75">
            

            

            <code class="ruby">    save!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="b6845982e215e07bf248b6f3d835cb8666e9d367">
  <div class="header">
    <h3>app/models/application_record.rb</h3>
    <h4>
      <span class="green">
  100.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>2</b> relevant lines.
      <span class="green"><b>2</b> lines covered</span> and
      <span class="red"><b>0</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class ApplicationRecord &lt; ActiveRecord::Base</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="2">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  primary_abstract_class</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="3">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="349df974fac31926228c4fc4ce8a3fe35e579c2e">
  <div class="header">
    <h3>app/models/conversation.rb</h3>
    <h4>
      <span class="yellow">
  89.29%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>28</b> relevant lines.
      <span class="green"><b>25</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Conversation &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # アソシエーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :user</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :messages, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="5">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :analyses, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="7">
            

            

            <code class="ruby">  # バリデーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="8">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :session_id, presence: true, uniqueness: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="10">
            

            

            <code class="ruby">  # コールバック</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="11">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  before_validation :generate_session_id, on: :create</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">  # スコープ</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="14">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :active, -&gt; { where(ended_at: nil) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="15">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :ended, -&gt; { where.not(ended_at: nil) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="16">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :recent, -&gt; { order(created_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :with_messages, -&gt; { includes(:messages) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # メソッド</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def active?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="21">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    ended_at.nil?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="23">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="24">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def end_conversation!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="25">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    update!(ended_at: Time.current) if active?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="26">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="27">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="28">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def duration</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="29">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    if ended_at</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      ended_at - created_at</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="31">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    elsif persisted?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">      Time.current - created_at</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby">    end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def message_count</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="37">
            

            

            <code class="ruby">    messages.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def latest_analysis</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="41">
            

            

            <code class="ruby">    analyses.order(created_at: :desc).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="42">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="43">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="44">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def add_message(content:, role:, metadata: {})</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="45">
            

            

            <code class="ruby">    messages.create!(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">      content: content,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby">      role: role,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">      metadata: metadata</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="50">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="52">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="54">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def generate_session_id</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="61" data-linenumber="55">
            
              <span class="hits">61</span>
            

            

            <code class="ruby">    self.session_id ||= SecureRandom.uuid</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="387a187f9cc7b49eadc710eda8aa9ed7edb6729a">
  <div class="header">
    <h3>app/models/message.rb</h3>
    <h4>
      <span class="green">
  91.89%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>37</b> relevant lines.
      <span class="green"><b>34</b> lines covered</span> and
      <span class="red"><b>3</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class Message &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # 定数</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  ROLES = %w[user assistant system].freeze</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  MAX_CONTENT_LENGTH = 10_000</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # アソシエーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  belongs_to :conversation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">  # バリデーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :content, presence: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby">                      length: { maximum: MAX_CONTENT_LENGTH }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="12">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :role, presence: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="13">
            

            

            <code class="ruby">                   inclusion: { in: ROLES }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="14">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="15">
            

            

            <code class="ruby">  # コールバック</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="16">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  after_create :update_conversation_timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="17">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  after_create :broadcast_message</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="18">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="19">
            

            

            <code class="ruby">  # デリゲーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="20">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  delegate :user, to: :conversation</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="22">
            

            

            <code class="ruby">  # スコープ</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="23">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">  scope :by_role, -&gt;(role) { where(role: role) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="24">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :user_messages, -&gt; { by_role(&#39;user&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="25">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :assistant_messages, -&gt; { by_role(&#39;assistant&#39;) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :recent, -&gt; { order(created_at: :desc) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="27">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">  scope :chronological, -&gt; { order(created_at: :asc) }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">  # メソッド</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="30">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def user?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="5" data-linenumber="31">
            
              <span class="hits">5</span>
            

            

            <code class="ruby">    role == &#39;user&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="32">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="33">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="34">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def from_user?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="35">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">    user?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="36">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="37">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="38">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def assistant?</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="39">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    role == &#39;assistant&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="40">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="41">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def from_assistant?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="43">
            

            

            <code class="ruby">    assistant?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="45">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="46">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def from_system?</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="47">
            

            

            <code class="ruby">    role == &#39;system&#39;</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="48">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def formatted_timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="51">
            

            

            <code class="ruby">    created_at.strftime(&#39;%Y年%m月%d日 %H:%M&#39;)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="53">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="54">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def word_count</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="55">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    content.split.size</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="56">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="57">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="58">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def add_metadata(key, value)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="59">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    self.metadata ||= {}</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="60">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    self.metadata[key] = value</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="4" data-linenumber="61">
            
              <span class="hits">4</span>
            

            

            <code class="ruby">    save!</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="62">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="63">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="64">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  private</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="65">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="66">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update_conversation_timestamp</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="67">
            

            

            <code class="ruby">    # touchと同じ動作だが、Rubocopの警告を回避</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="68">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">    conversation.update!(updated_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="69">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="70">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="71">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def broadcast_message</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="18" data-linenumber="72">
            
              <span class="hits">18</span>
            

            

            <code class="ruby">    ActionCable.server.broadcast(</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="73">
            

            

            <code class="ruby">      &quot;conversation_#{conversation_id}&quot;,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="74">
            

            

            <code class="ruby">      { message: as_json }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="75">
            

            

            <code class="ruby">    )</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="76">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="77">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
        <div class="source_table" id="ab4c1204c31a7b7406d353481725877193c325f5">
  <div class="header">
    <h3>app/models/user.rb</h3>
    <h4>
      <span class="green">
  92.0%
</span>

      lines covered
    </h4>

    

    <div class="t-line-summary">
      <b>25</b> relevant lines.
      <span class="green"><b>23</b> lines covered</span> and
      <span class="red"><b>2</b> lines missed.</span>
    </div>

    

  </div>

  <pre>
    <ol>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="1">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">class User &lt; ApplicationRecord</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="2">
            

            

            <code class="ruby">  # アソシエーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="3">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :conversations, dependent: :destroy</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="4">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  has_many :messages, through: :conversations</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="5">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="6">
            

            

            <code class="ruby">  # バリデーション</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="7">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :email, presence: true,</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="8">
            

            

            <code class="ruby">                    uniqueness: { case_sensitive: false },</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="9">
            

            

            <code class="ruby">                    format: { with: URI::MailTo::EMAIL_REGEXP }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="10">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  validates :name, presence: true</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="11">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="12">
            

            

            <code class="ruby">  # スコープ</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="13">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  scope :active_recently, -&gt; { where(&#39;last_active_at &gt; ?&#39;, 1.week.ago) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="14">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :active, -&gt; { where(&#39;last_active_at &gt; ?&#39;, 24.hours.ago) }</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="3" data-linenumber="15">
            
              <span class="hits">3</span>
            

            

            <code class="ruby">  scope :with_conversations, -&gt; { joins(:conversations).distinct }</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="16">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="17">
            

            

            <code class="ruby">  # メソッド</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="18">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def update_last_active!</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="19">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    update!(last_active_at: Time.current)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="20">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="21">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="22">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def active_conversation</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="23">
            

            

            <code class="ruby">    conversations.active.last</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="24">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="25">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="26">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def recent_conversations(limit = 10)</code>
          </li>
        </div>
      
        <div>
          <li class="missed" data-hits="0" data-linenumber="27">
            

            

            <code class="ruby">    conversations.includes(:messages)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="28">
            

            

            <code class="ruby">                 .order(created_at: :desc)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="29">
            

            

            <code class="ruby">                 .limit(limit)</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="30">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="31">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="32">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def display_name</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="2" data-linenumber="33">
            
              <span class="hits">2</span>
            

            

            <code class="ruby">    name.presence || email.split(&#39;@&#39;).first</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="34">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="35">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="36">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def conversation_count</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="37">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    conversations.count</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="38">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="39">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="40">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def average_sentiment_score</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="41">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    analyses = Analysis.joins(:conversation).where(conversations: { user_id: id })</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="42">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    scores = analyses.filter_map(&amp;:sentiment_score)</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="43">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    return nil if scores.empty?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="44">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="45">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    scores.sum.to_f / scores.size</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="46">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="47">
            

            

            <code class="ruby"></code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="48">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">  def admin?</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="49">
            

            

            <code class="ruby">    # TODO: 実際の管理者判定ロジックを実装</code>
          </li>
        </div>
      
        <div>
          <li class="covered" data-hits="1" data-linenumber="50">
            
              <span class="hits">1</span>
            

            

            <code class="ruby">    email&amp;.ends_with?(&#39;@admin.com&#39;) || false</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="51">
            

            

            <code class="ruby">  end</code>
          </li>
        </div>
      
        <div>
          <li class="never" data-hits="" data-linenumber="52">
            

            

            <code class="ruby">end</code>
          </li>
        </div>
      
    </ol>
  </pre>
</div>

      
      </div>
    </div>
  </body>
</html>
